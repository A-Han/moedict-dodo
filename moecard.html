<!DOCTYPE html>
<head>
<meta charset="utf-8">

<title>萌典閃卡</title>

<style type="text/css">
	.simple {
		text-decoration: none;
/*		text-transform: none; */
	}
</style>

<script src="javascript/jquery-1.9.1.min.js"></script>
<link rel="stylesheet" type="text/css" class="ui" href="css/semantic.min.css">


</head>

<body>

<script type="text/javascript">
	var bottonFunNow, objNow;
	var flipped = 0;
	var ansBig = '<div>歡迎使用活潑的萌典閃卡！<br/>請按Enter鍵開始。<br />手機橫放畫面較佳。</div><div></div>';
//	var ansQueqe = [ansBig];
	var ansQueqe = [{"zh":ansBig}];  //	alert(ansQueqe[0].zh);

	var start = 0; var faceNow = 0;
	var card = "單面"; var mode = "閃卡模式";
	var faceBack = "漢英";

	var indexM; // 之後還可加上用location.hash來給字庫的功能

	function pickone(list) {
		return list[Math.floor(Math.random() * list.length)];
	}

	function clearStr (str){
		return str.split('~').join('').split('`').join('').split('(S)').join('');
	}
	
	function innerBig () {
		var face1, face2, faceZh, faceEn;
		var data;
		
		if (flipped) {
			return;
		}
		else {
			if (ansQueqe[0]) {
				if (card == "雙面") data = ansQueqe[0];
				if (card == "單面") data = ansQueqe.shift();

				faceZh = "<div><a class = 'simple blue' href = "+"'https://www.moedict.tw/#"+data.zh+"' target = 'new'>"+data.zh+"</a></div>";
				faceEn = "<div>"+data.en+"</div>";

				switch (faceBack) {
					case "漢英":
						face1 = faceZh; face2 = faceEn; break;
					case "英漢":
						face1 = faceEn; face2 = faceZh; break;
				}

				if (card == "雙面") {
					$('#bigans').show().children("hr").hide();
					if (faceNow == 0) $('#bigans').html(face1);
					if (faceNow == 1) $('#bigans').html(face2);
				}

				if (card == "單面") $('#bigans').html(face1 + '<hr>'+face2);
			}
			else {
				document.getElementById('bigans').innerHTML ="<div class = 'cyan'>萌典讀取中...請3秒後再按一次Enter</div>";
			}
		}
	}

	function core (obj) {

		if (!indexM) {console.log('索引尚未讀取'); return};

		var newSrc = $("#source").val();
		var wordNow = pickone(indexM); //indexCore
		var wordNowD = decodeURIComponent(wordNow.replace(/\+/g,  " ")); // 國字

		console.log(wordNowD);
        
        $.getJSON("https://www.moedict.tw/a/"+wordNowD+".json", function(x){
        	var enWord, zhPrononce; // 英文, 注音
        	zhPrononce = x.h[0].b;

        	try {
        		enWord = x.translation.English[0];
        		if (enWord.substr(0,8) == 'same as `'){
        			console.log("發現"+enWord+"重新取得英文翻譯")
        			var nextWord = decodeURIComponent(enWord.split('same as `')[1].split('~')[0].replace(/\+/g,  " "));
        			enWord = $.getJSON("https://www.moedict.tw/a/"+nextWord+".json", function(x) {return x.translation.English[0]});
        		}
        		if (enWord.substr(0,8) == 'same as `'){
        			console.log("發現"+enWord+"重新取得英文翻譯")
        			var nextWord = decodeURIComponent(enWord.split('same as `')[1].split('~')[0].replace(/\+/g,  " "));
        			enWord = $.getJSON("https://www.moedict.tw/a/"+nextWord+".json", function(x) {return x.translation.English[0]});
        		}

        		console.log(enWord);
			    ansQueqe.push({"zh":wordNowD, "en":enWord});
        	}
	        catch (err) {
	        	console.log(err+"____條目「"+wordNowD+"」暫無英文翻譯");
				core(obj); 	// 條目無英文對照就換一張
	        }        			        	
	    });

	}


	function showAndCore (obj) {   // 預先讀好下次要顯示的資料，使用者按鍵時就不用等

		innerBig();	faceNow++;

		if (card != "雙面" || faceNow == 2) {
			core(obj);core(obj);
			if (faceNow == 2) {ansQueqe.shift();}
			faceNow = 0;
		}
	}

	// goal: 使用者可設定: 「是否加注音?」「存下顯示過的成為字庫」

	function runCode(e) {

		var keycode; 
		if (window.event) keycode = window.event.keyCode;
		else if (e) keycode = e.which;
		if (keycode == 13) {  // 32:Spacebar  13:ENTER
			bottonFunNow(objNow);
		}
	}

	function doSwi(obj, doCard, doFaceBack, word, doStart, doInner){
		if (confirm(word)) {
			if (doCard) card = doCard;
			if (doFaceBack) faceBack = doFaceBack;
			start = doStart;
			if (doInner) obj.innerHTML = doInner;
		}
	}

	function swi(obj) {
		var data = obj.innerHTML;
		core(obj);

		switch (data)
		{
			case "雙面" : 
				doSwi(obj, "單面",'', "換成單面卡?", 0, "單面"); break;
			case "單面" : 
				doSwi(obj, "雙面",'', "換成雙面卡?", 0, "雙面"); break;	
			case "漢英" : 
				doSwi(obj, '', "英漢", "改為英漢對照?", 0, "英漢");
				ansQueqe = []; core();
				break;
			case "英漢" : 
				doSwi(obj, '', "漢英", "改為漢英對照?", 0, "漢英");	
				ansQueqe = []; core();
				break
			case "自訂字庫" :
				var newSrc = $("#source").val();

				if (newSrc.substr(0,1) == '[') {
					indexM = eval(newSrc);
				}
				if (newSrc.substr(newSrc.length-4,4) == 'json') {
					$.getJSON("https://www.moedict.tw/c/index.json", function(x) {indexM = x});	
				}
				ansQueqe = []; core();
				break;		
			default : 
				alert("發生錯誤");
		};			
	}

	//目標：桌電 ==> Enter連閃, 按字查詢		手機&平板 ==> 右滑連閃, 按字查詢


	$.getJSON("https://www.moedict.tw/c/index.json", function(x) {
		indexM = x;	core();core();core();
	});

	bottonFunNow = showAndCore;
	document.onkeydown = runCode;

</script>

<button class="ui pink large button" onclick="swi(this)">單面</button>
<button class="ui pink large button" onclick="swi(this)">漢英</button>
<textarea id = "source" rows = "2" cols = "60">https://www.moedict.tw/c/index.json</textarea>
<button class="ui pink large button" onclick="swi(this)">自訂字庫</button>
<p align="center">
以json路徑或形如['萌','字典', '閃', '卡']之串列取代，即可自訂字庫。您可開一個記事本，諸存累積您的自訂字庫
</p>

<div class="ui message blue" style="height: 50ex;">
	<big><big id = "bigans" style="font-size: 400%; margin-left:20px;">
	</big></big>
</div>
<br />


<script type="text/javascript">
	showAndCore(); 
</script>

</body>
